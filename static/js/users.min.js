/**
* Tencent is pleased to support the open source community by making 蓝鲸智云PaaS平台社区版 (BlueKing PaaS Community Edition) available.
* Copyright (C) 2017-2018 THL A29 Limited, a Tencent company. All rights reserved.
* Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
* http://opensource.org/licenses/MIT
* Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/
function enter_keyword(e){if(e.keyCode=='13'){$('#serach_user').click()}}function is_user_edit_status(){if($("#user_table_div table tbody tr.user_edit_status").length>0){art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:'不可同时修改多个用户信息，请先保存编辑中的用户信息'}).time(5);return true}return false}$("#search_role").on('onchange',function(){get_user(1)})$("#serach_user").on('click',function(){get_user(1)})function get_user(page){var search_data=$("#search_data").val();var search_role=$("#search_role").val();var url=site_url+'accounts/user/list/query/';$.get(url,{'page':page,'search_data':search_data,'search_role':search_role},function(data){$("#user_table_div").html(data)})}function get_all_users(page){var url=site_url+'accounts/user/list/query/';$.get(url,{'page':page,'search_data':'','search_role':''},function(data){$("#user_table_div").html(data)})}$('.user_add_btn').on('click',function(){if(is_user_edit_status())return false;var tpl=['<tr class="user_record user_edit_status">','   <td>','       <input class="form-control u_username" placeholder="请输入用户名"/>','   </td>','    <td>','        <input class="form-control u_chname" placeholder="请输入姓名"/>','   </td>','   <td>','       <input class="form-control u_phone" placeholder="请输入联系电话"/>','   </td>','   <td>','       <input class="form-control u_email" placeholder="请输入邮箱"/>','   </td>','   <td>','       <select class="form-control u_role" style="width:90px">','           <option value="0">'+"普通用户"+'</option>','           <option value="1">'+"管理员"+'</option>','           <option value="2">'+"开发者"+'</option>','           <option value="3">'+"职能化用户"+'</option>','           <option value="4">'+"审计员"+'</option>','       </select>','   </td>','   <td>','       <button type="button" class="btn-xs user_cancel_btn">取消</button> ','       <button type="button" class="btn-info btn-xs user_save_btn">保存</button>','       <a href="###" title="编辑" class="dev_user_opera user_edit_btn"><span aria-hidden="true" class="glyphicon glyphicon-edit"></span></a>','       <a href="###" title="删除" class="dev_user_opera user_del_btn"><span aria-hidden="true" class="glyphicon glyphicon-remove-circle"></span></a>','      <a href="###" title="重置密码" class="dev_user_opera user_rest_btn"><span aria-hidden="true" class="glyphicon glyphicon-lock"></span></a>','   </td>','</tr>'].join('');$('#no_record_row').hide();$('#user_table').prepend($(tpl));return false});$(".user_export_btn").on('click',function(){window.location.href=site_url+'accounts/user/export/'})$('.user_import_btn').on('click',function(){$("#data_files").val('');art.dialog({id:"bktips",title:"批量导入用户",lock:true,width:560,content:$("#user_import_div").get(0),})$('#user_import_div').on('click','.import_btn',function(){var user_file=$("#data_files").val();if(user_file){$("#sumbit_import").click()}else{$("#error_msg").text('请选择一个文件')}})$("#error_msg").text('')})$('#user_table_div').on('click','.user_save_btn',function(){var btn_obj=$(this);var curRecord=$(this).closest('.user_record');var user_id=curRecord.attr('user_id');var u_username=$.trim(curRecord.find('.u_username').val());var u_chname=$.trim(curRecord.find('.u_chname').val());var u_phone=$.trim(curRecord.find('.u_phone').val());var u_email=$.trim(curRecord.find('.u_email').val());var u_role=$.trim(curRecord.find('.u_role').val());if(!u_username.match(/^[A-Za-z0-9][A-Za-z0-9._]{2,18}[A-Za-z0-9]$/)){art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:'用户名只能包含数字、字母、下划线和点，且长度在4-20个字符, 且必须以字母或数字开头'});curRecord.find('.u_username').focus();return false}if(!u_chname.match(/^[\u4e00-\u9fa5a-zA-Z0-9_]{1,16}$/)){art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:'中文名只能包含数字、字母、中文汉字、下划线，长度在1-16个字符'});curRecord.find('.u_chname').focus();return false}if(!u_phone.match(/^\d{10,11}$/)){art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:'仅支持中国大陆手机号码（11位数字）'});curRecord.find('.u_phone').focus();return false}if(!u_email.match(/^[A-Za-z0-9]+([-_.][A-Za-z0-9]+)*@([A-Za-z0-9]+[-.])+[A-Za-z0-9]{2,5}$/)){art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:'请输入正确的邮箱格式'});curRecord.find('.u_email').focus();return false}if(!u_role){art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:'请选择角色'});curRecord.find('.u_role').focus();return false}if(user_id){var url=site_url+'accounts/user/'+user_id+'/';$.ajax({url:url,type:"PUT",data:{username:u_username,chname:u_chname,phone:u_phone,role:u_role,email:u_email},success:function(data){if(data.result){art.dialog({id:'bktips',width:300,icon:'succeed',lock:true,content:'保存成功'}).time(1);curRecord.find('input').attr('disabled','disabled');curRecord.find('select').attr('disabled','disabled');curRecord.removeClass('user_edit_status');var cur_page=$("#current_page").val();get_user(cur_page)}else{art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:data.message})}},dataType:"json"})}else{var url=site_url+'accounts/user/';$.post(url,{username:u_username,chname:u_chname,phone:u_phone,role:u_role,email:u_email},function(data){if(data.result){art.dialog({id:'bktips',width:300,icon:'succeed',lock:true,content:'添加成功'}).time(1);user_data=data.data;curRecord.attr('user_id',user_data.user_id);curRecord.find('input').attr('disabled','disabled');curRecord.find('select').attr('disabled','disabled');curRecord.removeClass('user_edit_status');get_all_users(1)}else{art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:data.message})}},'json')}return false});$('#user_table_div').on('click','.user_edit_btn',function(){if(is_user_edit_status())return false;var curRecord=$(this).closest('.user_record');curRecord.addClass('user_edit_status');curRecord.find('input').removeAttr('disabled');curRecord.find('.u_username').attr('disabled','disabled');curRecord.find('select').removeAttr('disabled');var u_username=$.trim(curRecord.find('.u_username').val());var u_chname=$.trim(curRecord.find('.u_chname').val());var u_phone=$.trim(curRecord.find('.u_phone').val());var u_role=$.trim(curRecord.find('.u_role').val());var u_email=$.trim(curRecord.find('.u_email').val());curRecord.find('.u_username').attr('placeholder','请输入用户名');curRecord.find('.u_chname').attr('placeholder','请输入中文名');curRecord.find('.u_phone').attr('placeholder','请输入手机号');curRecord.find('.u_email').attr('placeholder','请输入邮箱');curRecord.attr('data-old-username',u_username);curRecord.attr('data-old-chname',u_chname);curRecord.attr('data-old-phone',u_phone);curRecord.attr('data-old-role',u_role);curRecord.attr('data-old-email',u_email);return false});$('#user_table_div').on('click','.user_cancel_btn',function(){var curRecord=$(this).closest('.user_record');curRecord.removeClass('user_edit_status');curRecord.find('input').attr('disabled','disabled');curRecord.find('select').attr('disabled','disabled');curRecord.find('.u_username').attr('placeholder','--');curRecord.find('.u_chname').attr('placeholder','--');curRecord.find('.u_phone').attr('placeholder','--');curRecord.find('.u_email').attr('placeholder','--');var u_username=curRecord.attr('data-old-username');var u_chname=curRecord.attr('data-old-chname');var u_phone=curRecord.attr('data-old-phone');var u_role=curRecord.attr('data-old-role');var u_email=curRecord.attr('data-old-email');if(u_username||u_chname||u_phone||u_email){curRecord.find('.u_username').val(u_username);curRecord.find('.u_chname').val(u_chname);curRecord.find('.u_phone').val(u_phone);curRecord.find('.u_role').val(u_role);curRecord.find('.u_email').val(u_email)}else{curRecord.remove()}var record_len=$("#user_table").find('.user_record').length;if(record_len==0){$("#no_record_row").show()}return false});$('#user_table_div').on('click','.user_del_btn',function(){var curRecord=$(this).closest('.user_record');var user_id=curRecord.attr('user_id');var u_username=curRecord.find('.u_username').val();var u_chname=curRecord.find('.u_chname').val();console.log(user_id);if(user_id){var url=site_url+'accounts/user/'+user_id+'/';var content="<div class='t_s14'>您确定删除该用户吗?<br>用户名 : "+u_username+"</div>";var width=340;art.dialog({title:"删除确认",width:width,icon:'question',lock:true,content:content,ok:function(){art.dialog({id:'bktips',width:300,icon:'warning',lock:true,content:'正在进行删除操作，请稍后...'});$.ajax({url:url,type:"DELETE",success:function(data){art.dialog({id:'bktips'}).close();if(data.result){art.dialog({id:'bktips',width:300,icon:'succeed',lock:true,content:data.message}).time(2);curRecord.remove();get_all_users(1)}else{art.dialog({id:'bktips',width:300,icon:'error',lock:true,content:data.message})}},dataType:"json"})},cancel:function(){},okVal:"确认删除",cancelVal:"取消"})}});$('#user_table_div').on('click','.user_rest_btn',function(){$('.error_tip').hide();$(".password_input").val('');$("#password_tip").text('');var curRecord=$(this).closest('.user_record');var user_id=curRecord.attr('user_id');var username=curRecord.find('.u_username').val();art.dialog({id:"bkpwd",title:"重置密码",lock:true,width:505,content:$("#change_password_div").get(0),cancelVal:"取消",cancel:function(){},okVal:"重置密码",ok:function(){var flag=true;$('.error_tip').hide();$("#pattern_tip").css('color','black');$(".password_input").each(function(){var curl_val=$.trim($(this).val());if(!curl_val){$(this).next('.error_tip').show();$(this).focus();flag=false;return false}if(!curl_val.match(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])[A-Za-z0-9!@#\$%\^\*\(\)-_\+=]{8,20}$/)&&$(this).attr('name')=='password1'){$("#pattern_tip").css('color','red');$(this).focus();flag=false;return false}});if(!flag){return false}var password1=$.trim($("#id_password1").val());var password2=$.trim($("#id_password2").val());if(password1!=password2){$("#password_tip").text('两次输入的新密码不一致');flag=false}if(!flag){return false}else{var url=site_url+'accounts/user/'+user_id+"/password/";var post_flag=true;$.ajax({url:url,type:'PUT',data:{'new_password1':password1,'new_password2':password2},success:function(data){if(!data.result){$("#password_tip").text(data.message);post_flag=false}},dataType:'json',async:false,});if(!post_flag){return false}else{art.dialog({width:300,icon:'succeed',lock:true,content:'密码重置成功'}).time(2)}}}})})
